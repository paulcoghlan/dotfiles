main_branch: main
agent: claude

# Aliases injected into the devcontainer's ~/.zshrc.
# workmux ignores this key; post_create reads it with yq.
aliases:
  - "alias gc='git commit'"
  - "alias gg='git log --oneline'"

post_create:
  # 1. Check dependencies
  - |
    for cmd in devcontainer yq; do
      if ! command -v "$cmd" &>/dev/null; then
        echo "Missing dependency: $cmd"
        [ "$cmd" = "devcontainer" ] && echo "  Install: npm install -g @devcontainers/cli"
        [ "$cmd" = "yq" ]          && echo "  Install: brew install yq"
        exit 1
      fi
    done

  # 2. Generate aliases file from this config
  - |
    yq '.aliases[]' ~/.config/workmux/config.yaml \
      > ~/.config/workmux/aliases.zsh 2>/dev/null \
      || echo "# no aliases" > ~/.config/workmux/aliases.zsh

  # 3. Create devcontainer config if not present
  - |
    if [ ! -d .devcontainer ]; then
      mkdir -p .devcontainer
      cat > .devcontainer/devcontainer.json << 'EOF'
    {
      "name": "Claude Code Dev",
      "image": "mcr.microsoft.com/devcontainers/typescript-node:1-20-bookworm",
      "remoteUser": "node",
      "containerEnv": {
        "ANTHROPIC_API_KEY": "${localEnv:ANTHROPIC_API_KEY}",
        "ANTHROPIC_MODEL": "${localEnv:ANTHROPIC_MODEL}",
        "ANTHROPIC_SMALL_FAST_MODEL": "${localEnv:ANTHROPIC_SMALL_FAST_MODEL}",
        "ANTHROPIC_BASE_URL": "${localEnv:ANTHROPIC_BASE_URL}"
      },
      "mounts": [
        "source=${localEnv:HOME}/.gitconfig,target=/home/node/.gitconfig,type=bind",
        "source=${localEnv:HOME}/.config/workmux/aliases.zsh,target=/home/node/.config/workmux/aliases.zsh,type=bind",
        "source=${localEnv:HOME}/.claude.json,target=/home/node/.claude.json,type=bind",
        "source=${localEnv:HOME}/.claude,target=/home/node/.claude,type=bind,consistency=cached"
      ],
      "postCreateCommand": "curl -fsSL https://claude.ai/install.sh | bash && mkdir -p ~/.config/workmux && echo '[ -f ~/.config/workmux/aliases.zsh ] && source ~/.config/workmux/aliases.zsh' >> ~/.zshrc"
    }
    EOF
    fi

  # 4. Start devcontainer
  - |
    touch ~/.claude.json
    mkdir -p ~/.claude
    [ -f "$HOME/.dont-commit-env" ] && set -a && . "$HOME/.dont-commit-env" && set +a
    devcontainer up --workspace-folder . || {
      echo "Failed to start devcontainer. Is Docker running?"
      exit 1
    }

panes:
  - command: devcontainer exec --workspace-folder . claude --dangerously-skip-permissions
    focus: true
  - split: horizontal
